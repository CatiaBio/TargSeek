# config/config_analysis.yaml
# ------------------------------------------------------
# Configuration file for TargSeek Analysis Pipeline
#
# Defines all paths, thresholds, and settings for protein sequence
# analysis, multiple sequence alignment, conservation analysis,
# and epitope prediction.
# 
# Only this file needs to be edited to adjust analysis parameters,
# thresholds, or update paths without modifying the Snakefile_analysis.
# ------------------------------------------------------

# =============================================================================
# PIPELINE CONFIGURATION
# =============================================================================

# Analysis batches - should match those used in download pipeline
species_batches:
  - analysis1
  #- analysis2
  #- analysis3

# QuickGO parameter sets - should match those used in download pipeline
quickgo_paramsets:
  - params1
  #- params2
  #- params3

# Defined Gram stain groups - should match download config
groups:
  - positive
  - negative

# =============================================================================
# ANALYSIS PARAMETERS
# =============================================================================

# MAFFT alignment settings
mafft:
  threads: 8
  # Choose which alignment type to use for downstream analysis:
  # "no_3d" - Use alignments without 3D structures
  # "with_3d" - Use alignments with 3D structures included
  use_3d_alignments: "no_3d"
  # Additional MAFFT parameters
  algorithm: "auto"  # auto, linsi, ginsi, einsi, fftns, fftnsi
  max_iterations: 1000

# 3D Structure Selection settings
structure_selection:
  # Selection method: "similarity" (compare against protein sequences) or "priority" (organism priority)
  method: "similarity"
  # Maximum number of 3D structures to include per gene
  max_structures_per_gene: 1
  # Minimum combined score to include a structure (0.0-1.0)
  min_similarity_score: 0.1
  # Minimum coverage percentage of common amino acid stretches (0-100)
  min_coverage_percentage: 10.0
  # Similarity calculation method: "local_alignment", "global_alignment", or "lcs"
  similarity_method: "local_alignment"
  
  # Combined scoring weights (must sum to 1.0)
  scoring_weights:
    # Weight for length similarity (how close structure length is to MSA average)
    length: 0.5
    # Weight for sequence similarity (amino acid identity in alignment)
    similarity: 0.3
    # Weight for coverage (how well structure aligns with MSA sequences)  
    coverage: 0.2
  
  # Length-based filtering options
  length_filtering:
    # Enable length-based pre-filtering before alignment
    enable_prefilter: false
    # Maximum allowed deviation from MSA average length (as percentage)
    # E.g., 0.5 = structures can be 50% longer or shorter than MSA average
    max_length_deviation: 0.5

# Pipeline processing options
processing:
  # Enable/disable no_3d processing (alignments without 3D structures)
  enable_no_3d: false
  # Enable/disable with_3d processing (alignments with 3D structures)
  enable_with_3d: true
  
# MSA Trimming settings - ClipKIT (preferred) or trimAl (legacy)
trimming:
  # Trimming tool: "clipkit" (recommended) or "trimal" (legacy)
  method: "clipkit"
  
  # ClipKIT settings (when method="clipkit")
  clipkit:
    # ClipKIT mode: "smart-gap" (recommended), "kpic", "kpic-smart-gap", "kpi", "gappy", etc.
    mode: "smart-gap"
  
  # trimAl settings (when method="trimal" or as fallback)
  trimal:
    # Trimming method: "automated1", "gappyout", "strict", or "custom"
    method: "automated1"
    # Custom gap threshold (0.0-1.0, only used if method is "custom")
    gap_threshold: 0.5
    # Minimum sequence similarity threshold
    similarity_threshold: 0.001

# Conservation analysis settings
conservation:
  # Minimum conservation score (0.0-1.0)
  min_conservation_score: 0.7
  # Window size for conservation analysis
  window_size: 5
  # Minimum number of sequences required for analysis
  min_sequences: 3
  # Create sequence logos
  create_logos: false

# Conserved sequence extraction configuration
conserved:
  # Minimum conservation score for including positions in conserved sequences (0.0-1.0)
  min_conservation: 0.5
  # Minimum length of conserved sequences to include in output (amino acids)
  min_length: 5

# BepiPred 3.0 epitope prediction configuration
bepipred:
  # Path to BepiPred 3.0 installation
  path: "tools/BepiPred3.0"
  # Prediction method: 'vt_pred' (recommended) or 'mjv_pred'
  method: "vt_pred"
  # Epitope score threshold (0.0-1.0, higher = more confident predictions)
  threshold: 0.5
  # Minimum epitope length (amino acids)
  min_epitope_length: 6
  # Top percentage of epitope residues to include (0.0-1.0)
  top_percentage: 0.5
  # Raw only mode: skip HTML visualizations and extra files for faster processing
  raw_only: true


# Quality control thresholds
quality_control:
  # Minimum alignment length after trimming
  min_alignment_length: 50
  # Minimum number of species per alignment
  min_species_per_alignment: 3
  # Maximum gap percentage allowed in final alignment
  max_gap_percentage: 0.8

# Output settings
output:
  # Generate detailed logs for each step
  detailed_logs: true
  # Generate intermediate files for debugging
  keep_intermediate_files: false
  # Generate visualization plots
  generate_plots: true

# =============================================================================
# FILE SYSTEM PATHS
# =============================================================================

# Path templates - organized by analysis workflow stage
paths:
  
  # -------------------------------------------------------------------------  
  # INPUT DATA (from download pipeline)
  # -------------------------------------------------------------------------
  input:
    # Gene selection results from download pipeline
    gene_lists: "results/{analysis}_{paramset}/gene_selection/genes_species/gram_{group}"
    protein_sequences: "data/protein_sequences"
    protein_download_sentinel: "data/protein_sequences/.{analysis}_{paramset}_{group}_download_complete"
    structures_download_sentinel: "data/protein_structures/.{analysis}_{paramset}_{group}_structures_complete"
    coverage_data: "results/{analysis}_{paramset}/gene_selection/coverage_count.tsv"
    proteins_to_study: "results/{analysis}_{paramset}/gene_selection/selected_genes_gram_{group}.txt"

  # -------------------------------------------------------------------------
  # STAGE 1: Sequence Preparation
  # -------------------------------------------------------------------------
  sequence_prep:
    # Base directory for all analysis outputs
    base_dir: "results/{analysis}_{paramset}/protein_analysis"
    # MSA sequence references  
    msa_sequence_refs: "results/{analysis}_{paramset}/protein_analysis/msa_sequence_refs/gram_{group}"
    # Selected 3D structure paths
    selected_3d_paths: "results/{analysis}_{paramset}/protein_analysis/selected_3d_paths_gram_{group}.txt"
    selected_3d_tsv: "results/{analysis}_{paramset}/protein_analysis/selected_3d_fasta_gram_{group}.tsv"

  # -------------------------------------------------------------------------
  # STAGE 2: Multiple Sequence Alignment
  # -------------------------------------------------------------------------
  msa:
    # Main MSA sequences (foundation for both no_3d and with_3d)
    main_sequences: "results/{analysis}_{paramset}/protein_analysis/main_msa_sequences/gram_{group}"
    
    # Final MSA input sequences (FASTA files by gene)
    sequences_main: "results/{analysis}_{paramset}/protein_analysis/main_msa_sequences/gram_{group}"
    sequences_structure: "results/{analysis}_{paramset}/protein_analysis/structure_msa_sequences/gram_{group}"
    
    # MAFFT alignment results
    alignments_main: "results/{analysis}_{paramset}/protein_analysis/main_alignments/gram_{group}"
    alignments_structure: "results/{analysis}_{paramset}/protein_analysis/structure_alignments/gram_{group}"
    
    # trimAl trimmed alignments
    trimmed_main: "results/{analysis}_{paramset}/protein_analysis/main_trimmed/gram_{group}"
    trimmed_structure: "results/{analysis}_{paramset}/protein_analysis/structure_trimmed/gram_{group}"

  # -------------------------------------------------------------------------
  # STAGE 3: Quality Assessment
  # -------------------------------------------------------------------------
  quality:
    # Alignment quality metrics
    assessment_main: "results/{analysis}_{paramset}/protein_analysis/main_msa_quality/gram_{group}"
    assessment_structure: "results/{analysis}_{paramset}/protein_analysis/structure_msa_quality/gram_{group}"

  # -------------------------------------------------------------------------
  # STAGE 4: Conservation Analysis
  # -------------------------------------------------------------------------
  conservation:
    # Conservation analysis results
    results_main: "results/{analysis}_{paramset}/protein_analysis/main_conservation/gram_{group}"
    results_structure: "results/{analysis}_{paramset}/protein_analysis/structure_conservation/gram_{group}"

  # -------------------------------------------------------------------------
  # STAGE 5: Conserved Sequence Extraction
  # -------------------------------------------------------------------------
  conserved:
    # Conserved sequences from raw alignments
    raw_sequences_main: "results/{analysis}_{paramset}/protein_analysis/main_conserved_sequences_raw_gram_{group}.tsv"
    raw_sequences_structure: "results/{analysis}_{paramset}/protein_analysis/structure_conserved_sequences_raw_gram_{group}.tsv"
    # Conserved sequences from trimmed alignments
    trimmed_sequences_main: "results/{analysis}_{paramset}/protein_analysis/main_conserved_sequences_trimmed_gram_{group}.tsv"
    trimmed_sequences_structure: "results/{analysis}_{paramset}/protein_analysis/structure_conserved_sequences_trimmed_gram_{group}.tsv"

  # -------------------------------------------------------------------------
  # STAGE 6: Epitope Prediction
  # -------------------------------------------------------------------------
  epitopes:
    # BepiPred 3.0 predictions
    bepipred_predictions: "results/{analysis}_{paramset}/protein_analysis/epitope_predictions_bepipred"

  # -------------------------------------------------------------------------
  # STAGE 6: Summaries and Reports  
  # -------------------------------------------------------------------------
  # reports:
    # Final integrated reports (EXCLUDED from this pipeline)
    # final_report: "results/{analysis}_{paramset}/protein_analysis_report_{use_3d_dir}.html"

# =============================================================================
# SCRIPT PATHS
# =============================================================================

# Script paths - organized by analysis stage
scripts:
  
  # -------------------------------------------------------------------------
  # STAGE 1: Sequence Preparation Scripts
  # -------------------------------------------------------------------------
  sequence_prep:
    create_sequence_references: "scripts/protein_analysis/create_sequence_references.py"
    create_main_msa: "scripts/protein_analysis/create_main_msa_sequences.py"
    select_3d_from_main_msa: "scripts/protein_analysis/select_3d_from_main_msa.py"
    create_final_msa: "scripts/protein_analysis/create_final_msa_files.py"
  
  # -------------------------------------------------------------------------
  # STAGE 2: Multiple Sequence Alignment Scripts  
  # -------------------------------------------------------------------------
  msa:
    run_mafft_alignments: "scripts/protein_analysis/run_mafft_alignments.py"
    trim_alignments: "scripts/protein_analysis/trim_alignments.py"
  
  # -------------------------------------------------------------------------
  # STAGE 3: Quality Assessment Scripts
  # -------------------------------------------------------------------------
  quality:
    assess_alignment_quality: "scripts/protein_analysis/assess_alignment_quality_comparison.py"
  
  # -------------------------------------------------------------------------
  # STAGE 4: Conservation Analysis Scripts
  # -------------------------------------------------------------------------
  conservation:
    analyze_conservation: "scripts/protein_analysis/analyze_conservation_adaptive.py"
  
  # -------------------------------------------------------------------------
  # STAGE 5: Conserved Sequence Extraction Scripts
  # -------------------------------------------------------------------------
  conserved:
    extract_sequences: "scripts/protein_analysis/extract_conserved_sequences.py"
  
  # -------------------------------------------------------------------------
  # STAGE 6: Epitope Prediction Scripts
  # -------------------------------------------------------------------------
  epitopes:
    predict_epitopes_bepipred: "scripts/protein_analysis/predict_epitopes_bepipred_3d_only.py"
  
  # -------------------------------------------------------------------------
  # STAGE 6: Summary and Report Scripts
  # -------------------------------------------------------------------------
  # reports:
    # generate_final_report: "scripts/protein_analysis/generate_final_report.py"  # EXCLUDED